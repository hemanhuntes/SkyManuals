// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Epic-01: Structured Authoring & Collaboration Models

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Epic-01 Relations
  memberships Membership[]
  authoredChangeSets ChangeSet[] @relation("ChangeSetAuthor")
  editorSessions EditorSession[]
  
  // Epic-02 Relations
  initiatedWorkflows WorkflowInstance[] @relation("WorkflowInstanceInitiatedBy")
  cancelledWorkflows WorkflowInstance[] @relation("WorkflowInstanceCancelledBy")
  assignedTasks ApprovalTask[]
  completedTasks ApprovalTask[] @relation("ApprovalTaskCompletedBy")
  comments Comment[]
  completedChecklists Checklist[] @relation("ChecklistCompletedBy")
  notifications Notification[]
  
  // Epic-03 Relations
  accessPermissions AccessPermission[]
  annotations Annotation[]
  readerSessions ReaderSession[]
  suggestEdits SuggestEdit[]
  offlineCaches OfflineCache[]
  readerAnalytics ReaderAnalytics[]
  
  @@map("users")
}

model Organization {
  id       String   @id @default(cuid())
  name     String
  slug     String   @unique
  logoUrl  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Epic-01 Relations
  memberships Membership[]
  manuals Manual[]
  templates Template[]
  
  // Epic-02 Relations
  workflowDefinitions WorkflowDefinition[]
  checklists Checklist[]
  checklistTemplates ChecklistTemplate[]
  
  // Epic-03 Relations
  featureFlags FeatureFlag[]
  
  // Epic-04 Relations
  complianceAlerts ComplianceAlert[]
  auditChecklists AuditChecklist[]
  libraryUpdateJobs LibraryUpdateJob[]
  complianceAnalytics ComplianceAnalytics[]
  
  // Epic-05 Relations
  searchIndexes SearchIndex[]
  
  @@map("organizations")
}

model Membership {
  id      String @id @default(cuid())
  userId  String
  organizationId String
  role    Role
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  @@unique([userId, organizationId])
  @@map("memberships")
}

model Manual {
  id      String @id @default(cuid())
  organizationId String
  title   String
  status  ManualStatus @default(DRAFT)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  chapters Chapter[]
  changeSets ChangeSet[]
  releaseSnapshots ReleaseSnapshot[]
  versions Version[]
  
  // Epic-03 Relations
  readerBundles ReaderBundle[]
  accessPermissions AccessPermission[]
  searchIndexes SearchIndex[]
  annotations Annotation[]
  readerSessions ReaderSession[]
  suggestEdits SuggestEdit[]
  revisionBars RevisionBar[]
  operationallyCriticalFlags OperationallyCriticalFlag[]
  readerAnalytics ReaderAnalytics[]
  
  // Epic-04 Relations
  complianceLinks ComplianceLink[]
  auditChecklists AuditChecklist[]
  coverageAnalyses CoverageAnalysis[]
  
  // Epic-05 Relations
  searchIndexes SearchIndex[]
  
  @@map("manuals")
}

model Chapter {
  id      String @id @default(cuid())
  manualId String
  title   String
  number  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  manual Manual @relation(fields: [manualId], references: [id], onDelete: Cascade)
  sections Section[]
  
  // Epic-05 Relations
  searchIndexes SearchIndex[]
  
  @@unique([manualId, number])
  @@map("chapters")
}

model Section {
  id      String @id @default(cuid())
  chapterId String
  title   String
  number  String
  status  SectionStatus @default(DRAFT)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  chapter Chapter @relation(fields: [chapterId], references: [id], onDelete: Cascade)
  blocks Block[]
  editorSessions EditorSession[]
  
  // Epic-05 Relations
  searchIndexes SearchIndex[]
  
  @@unique([chapterId, number])
  @@map("sections")
}

model Block {
  id      String @id @default(cuid())
  sectionId String
  content Json // TipTap JSON format
  smartBlockType SmartBlockType?
  smartBlockConfig Json? // Smart block configuration
  attachments String[] // Array of attachment IDs
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  section Section @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  
  // Epic-05 Relations
  searchIndexes SearchIndex[]
  
  @@map("blocks")
}

model Attachment {
  id            String @id @default(cuid())
  fileName      String
  originalFileName String
  mimeType      String
  size          Int
  uploadedBy    String
  uploadedAt    DateTime @default(now())
  
  @@map("attachments")
}

model Version {
  id         String @id @default(cuid())
  etag       String @unique // UUID for optimistic locking
  manualId   String
  chapterId  String?
  sectionId  String?
  blockId    String?
  changeSetId String
  createdAt  DateTime @default(now())
  
  // Relations
  manual Manual @relation(fields: [manualId], references: [id], onDelete: Cascade)
  changeSet ChangeSet @relation(fields: [changeSetId], references: [id], onDelete: Cascade)
  editorSessions EditorSession[]
  
  @@map("versions")
}

model ChangeSet {
  id          String @id @default(cuid())
  manualId    String
  title       String
  description String?
  authorId    String
  status      ChangeSetStatus @default(PENDING)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  manual Manual @relation(fields: [manualId], references: [id], onDelete: Cascade)
  author User @relation("ChangeSetAuthor", fields: [authorId], references: [id], onDelete: Cascade)
  changes Change[]
  versions Version[]
  releaseSnapshots ReleaseSnapshot[]
  
  @@map("change_sets")
}

model Change {
  id          String @id @default(cuid())
  changeSetId String
  entityType  EntityType
  entityId    String
  changeType  ChangeType
  oldValue    Json?
  newValue    Json?
  diff        String? // Textual diff representation
  createdAt   DateTime @default(now())
  
  // Relations
  changeSet ChangeSet @relation(fields: [changeSetId], references: [id], onDelete: Cascade)
  
  @@map("changes")
}

model ReleaseSnapshot {
  id             String @id @default(cuid())
  manualId       String
  changeSetId    String
  version        String
  contentSnapshot Json // Immutable snapshot of manual content
  createdAt      DateTime @default(now())
  
  // Relations
  manual Manual @relation(fields: [manualId], references: [id], onDelete: Cascade)
  changeSet ChangeSet @relation(fields: [changeSetId], references: [id], onDelete: Cascade)
  
  // Epic-03 Relations
  readerBundles ReaderBundle[]
  
  @@map("release_snapshots")
}

model Template {
  id            String @id @default(cuid())
  organizationId String
  name          String
  description   String?
  blocks        Json // Array of TipTap documents
  smartBlocks   Json // Array of smart block definitions
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  @@map("templates")
}

model EditorSession {
  id           String @id @default(cuid())
  userId       String
  sectionId    String
  versionId    String
  isActive     Boolean @default(true)
  lastActivity DateTime @default(now())
  createdAt    DateTime @default(now())
  
  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  section Section @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  version Version @relation(fields: [versionId], references: [id], onDelete: Cascade)
  
  @@unique([userId, sectionId])
  @@map("editor_sessions")
}

// Enums
enum Role {
  ADMIN
  EDITOR
  REVIEWER
  READER
}

enum ManualStatus {
  DRAFT
  RELEASED
}

enum SectionStatus {
  DRAFT
  RELEASED
}

enum SmartBlockType {
  LEP
  MEL
  ChangeLog
  RevisionBar
  CrossRef
}

enum EntityType {
  MANUAL
  CHAPTER
  SECTION
  BLOCK
}

enum ChangeType {
  CREATE
  UPDATE
  DELETE
  MERGE
}

enum ChangeSetStatus {
  PENDING
  APPROVED
  REJECTED
  MERGED
}

// Epic-02: Configurable Review & Approval Models

model WorkflowDefinition {
  id             String @id @default(cuid())
  organizationId String
  name           String
  description    String?
  entityType     EntityType // Which entity this workflow applies to
  stages         Json // Array of WorkflowStage objects
  isActive       Boolean @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  workflowInstances WorkflowInstance[]
  
  @@map("workflow_definitions")
}

model WorkflowInstance {
  id                  String @id @default(cuid())
  workflowDefinitionId String
  entityType          EntityType
  entityId            String
  title               String
  description         String?
  initiatedByUserId   String
  currentStageId      String?
  status              WorkflowInstanceStatus @default(DRAFT)
  priority            WorkflowPriority @default(MEDIUM)
  metadata            Json? // Flexible metadata for workflow context
  scheduledAt         DateTime?
  startedAt           DateTime?
  completedAt         DateTime?
  cancelledAt         DateTime?
  cancelledByUserId   String?
  rejectionReason     String?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  // Relations
  workflowDefinition WorkflowDefinition @relation(fields: [workflowDefinitionId], references: [id], onDelete: Cascade)
  initiatedBy User @relation("WorkflowInstanceInitiatedBy", fields: [initiatedByUserId], references: [id], onDelete: Cascade)
  cancelledBy User? @relation("WorkflowInstanceCancelledBy", fields: [cancelledByUserId], references: [id], onDelete: SetNull)
  tasks ApprovalTask[]
  checklists Checklist[]
  
  @@map("workflow_instances")
}

model ApprovalTask {
  id               String @id @default(cuid())
  workflowInstanceId String
  stageId          String
  assignedToUserId String
  entityType       EntityType
  entityId         String
  priority         WorkflowPriority @default(MEDIUM)
  status           TaskStatus @default(PENDING)
  dueAt            DateTime?
  completedAt      DateTime?
  completedByUserId String?
  commentsCount    Int @default(0)
  attachments      String[] // Array of attachment IDs
  metadata         Json? // Flexible metadata for task context
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  // Relations
  workflowInstance WorkflowInstance @relation(fields: [workflowInstanceId], references: [id], onDelete: Cascade)
  assignedTo User @relation(fields: [assignedToUserId], references: [id], onDelete: Cascade)
  completedBy User? @relation("ApprovalTaskCompletedBy", fields: [completedByUserId], references: [id], onDelete: SetNull)
  comments Comment[]
  
  @@map("approval_tasks")
}

model Comment {
  id               String @id @default(cuid())
  taskId           String
  userId           String
  content          String
  type             CommentType @default(GENERAL)
  isInternal       Boolean @default(false)
  attachments      String[] // Array of attachment IDs
  mentionedUserIds String[] // Array of mentioned user IDs for notifications
  parentCommentId  String? // For threaded discussions
  isResolved       Boolean @default(false)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  // Relations
  task ApprovalTask @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  parentComment Comment? @relation("CommentThread", fields: [parentCommentId], references: [id], onDelete: Cascade)
  replies Comment[] @relation("CommentThread")
  
  @@map("comments")
}

model Checklist {
  id               String @id @default(cuid())
  taskId           String?
  workflowInstanceId String?
  title            String
  description      String?
  organizationId   String
  type             ChecklistType @default(AUDIT)
  templateId       String?
  items            Json // Array of ChecklistItem objects
  isComplete       Boolean @default(false)
  completedAt      DateTime?
  completedByUserId String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  // Relations
  task ApprovalTask? @relation(fields: [taskId], references: [id], onDelete: SetNull)
  workflowInstance WorkflowInstance? @relation(fields: [workflowInstanceId], references: [id], onDelete: SetNull)
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  completedBy User? @relation("ChecklistCompletedBy", fields: [completedByUserId], references: [id], onDelete: SetNull)
  
  @@map("checklists")
}

model ChecklistTemplate {
  id             String @id @default(cuid())
  organizationId String
  name           String
  description    String?
  type           ChecklistType @default(AUDIT)
  isDefault      Boolean @default(false)
  items          Json // Array of ChecklistItem objects (without task-specific fields)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  @@map("checklist_templates")
}

model Notification {
  id           String @id @default(cuid())
  userId       String
  type         NotificationType
  title        String
  message      String
  channels     NotificationChannel[] // Array of notification channels
  entityType   EntityTypeNotification?
  entityId     String?
  isRead       Boolean @default(false)
  readAt       DateTime?
  scheduledFor DateTime? // For delayed/reminder notifications
  deliveredAt  DateTime?
  metadata     Json? // Flexible notification metadata
  createdAt    DateTime @default(now())
  
  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("notifications")
}

model ApprovalSignature {
  id               String @id @default(cuid())
  workflowInstanceId String
  signerName       String
  signerRole       String
  signatureDate    DateTime
  signaturePath    String? // Path to signature file or hash
  signaturePayload Json? // Encrypted signature data
  isValid          Boolean @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  @@map("approval_signatures")
}

// Epic-02 Enums
enum WorkflowInstanceStatus {
  DRAFT
  IN_PROGRESS
  APPROVED
  REJECTED
  SUSPENDED
  CANCELLED
  COMPLETED
}

enum TaskStatus {
  PENDING
  APPROVED
  REJECTED
  DELEGATED
  SUSPENDED
  COMPLETED
}

enum CommentType {
  GENERAL
  APPROVAL_REASON
  REJECTION_REASON
  DELEGATION_NOTE
}

enum ChecklistType {
  AUDIT
  REVIEW
  COMPLIANCE
  CUSTOM
}

enum WorkflowPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum NotificationType {
  TASK_ASSIGNED
  TASK_DUE_SOON
  TASK_OVERDUE
  COMMENT_ADDED
  WORKFLOW_STATUS_CHANGE
  APPROVAL_REQUEST
  REJECTION_WITH_COMMENTS
  MENTION
}

enum NotificationChannel {
  EMAIL
  WEB_PUSH
  IN_APP
  SLACK
}

enum EntityTypeNotification {
  TASK
  WORKFLOW_INSTANCE
  COMMENT
}

// Epic-03: Distribution & Reader Models

model ReaderBundle {
  id               String @id @default(cuid())
  manualId         String
  releaseSnapshotId String
  version          String
  bundleUrl        String // CDN URL to static JSON bundle
  bundleSize       Int    // Size in bytes
  createdAt        DateTime @default(now())
  expiresAt        DateTime? // For time-limited access
  
  // Relations
  manual Manual @relation(fields: [manualId], references: [id], onDelete: Cascade)
  releaseSnapshot ReleaseSnapshot @relation(fields: [releaseSnapshotId], references: [id], onDelete: Cascade)
  
  @@map("reader_bundles")
}

model AccessPermission {
  id          String @id @default(cuid())
  userId      String
  manualId    String
  bundleId    String
  permission  Permission
  grantedBy   String
  grantedAt   DateTime @default(now())
  expiresAt   DateTime?
  metadata    Json? // Flexible metadata
  
  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  manual Manual @relation(fields: [manualId], references: [id], onDelete: Cascade)
  readerBundle ReaderBundle @relation(fields: [bundleId], references: [id], onDelete: Cascade)
  
  @@unique([userId, manualId, bundleId])
  @@map("access_permissions")
}

model SearchIndex {
  id            String @id @default(cuid())
  manualId      String
  bundleId      String
  searchableText String
  indexes       Json // Structured index data
  createdAt     DateTime @default(now())
  
  // Relations
  manual Manual @relation(fields: [manualId], references: [id], onDelete: Cascade)
  readerBundle ReaderBundle @relation(fields: [bundleId], references: [id], onDelete: Cascade)
  
  @@unique([manualId, bundleId])
  @@map("search_indexes")
}

model Annotation {
  id          String @id @default(cuid())
  userId      String
  manualId    String
  bundleId    String
  chapterId   String
  sectionId   String
  blockId     String
  selector    String // CSS selector or text range
  type        AnnotationType
  content     String
  color       String? // For highlights
  isPrivate   Boolean @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  manual Manual @relation(fields: [manualId], references: [id], onDelete: Cascade)
  readerBundle ReaderBundle @relation(fields: [bundleId], references: [id], onDelete: Cascade)
  
  @@map("annotations")
}

model ReaderSession {
  id                String @id @default(cuid())
  userId            String
  manualId          String
  bundleId          String
  currentChapterId  String?
  currentSectionId  String?
  readingProgress   Int @default(0) // Percentage (0-100)
  readingTimeSeconds Int @default(0)
  lastAccessedAt    DateTime @default(now())
  bookmarks         Json // Array of bookmark objects
  annotations        String[] // Annotation IDs
  notes              String[] // Note IDs
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  manual Manual @relation(fields: [manualId], references: [id], onDelete: Cascade)
  readerBundle ReaderBundle @relation(fields: [bundleId], references: [id], onDelete: Cascade)
  
  @@unique([userId, manualId, bundleId])
  @@map("reader_session")
}

model SuggestEdit {
  id               String @id @default(cuid())
  userId           String
  manualId         String
  bundleId         String
  chapterId        String
  sectionId        String
  blockId          String
  selector         String // Text selection within block
  currentText      String
  suggestedText    String
  reason           String
  priority         SuggestEditPriority @default(MEDIUM)
  status           SuggestEditStatus @default(PENDING)
  createdTaskId    String? // Link to editor task
  reviewedBy       String?
  reviewedAt       DateTime?
  reviewerComments String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  manual Manual @relation(fields: [manualId], references: [id], onDelete: Cascade)
  readerBundle ReaderBundle @relation(fields: [bundleId], references: [id], onDelete: Cascade)
  
  @@map("suggest_edits")
}

model RevisionBar {
  id           String @id @default(cuid())
  manualId     String
  bundleId     String
  chapterId    String
  sectionId    String
  blockId      String
  revisionType RevisionType
  oldVersion   String?
  newVersion   String
  description  String
  authorName   String
  changedAt    DateTime
  createdAt    DateTime @default(now())
  
  // Relations
  manual Manual @relation(fields: [manualId], references: [id], onDelete: Cascade)
  readerBundle ReaderBundle @relation(fields: [bundleId], references: [id], onDelete: Cascade)
  
  @@map("revision_bars")
}

model OfflineCache {
  id          String @id @default(cuid())
  userId      String
  bundleId    String
  cacheKey    String
  data        Json // Cached bundle data
  cachedAt    DateTime @default(now())
  expiresAt   DateTime
  version     String
  checksum    String
  
  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  readerBundle ReaderBundle @relation(fields: [bundleId], references: [id], onDelete: Cascade)
  
  @@unique([userId, bundleId])
  @@map("offline_cache")
}

model FeatureFlag {
  id             String @id @default(cuid())
  name           String
  organizationId String
  enabled        Boolean @default(false)
  description    String?
  conditions     Json // Array of condition objects
  metadata       Json?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  @@map("feature_flags")
}

model OperationallyCriticalFlag {
  id                    String @id @default(cuid())
  manualId              String
  bundleId              String
  isCritical            Boolean @default(false)
  requiredRoles         String[] // Array of required roles
  accessMethod          AccessMethod
  distributionChannels  String[] // Distribution channel identifiers
  versionPinRequired    Boolean @default(false)
  auditLoggingRequired  Boolean @default(true)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  
  // Relations
  manual Manual @relation(fields: [manualId], references: [id], onDelete: Cascade)
  readerBundle ReaderBundle @relation(fields: [bundleId], references: [id], onDelete: Cascade)
  
  @@unique([manualId, bundleId])
  @@map("operationally_critical_flags")
}

model ReaderAnalytics {
  id         String @id @default(cuid())
  userId     String
  manualId   String
  bundleId   String
  event      ReaderEventType
  metadata   Json? // Additional event metadata
  timestamp  DateTime @default(now())
  sessionId  String
  
  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  manual Manual @relation(fields: [manualId], references: [id], onDelete: Cascade)
  readerBundle ReaderBundle @relation(fields: [bundleId], references: [id], onDelete: Cascade)
  
  @@map("reader_analytics")
}

// Epic-03 Enums

enum Permission {
  READ
  ANNOTATE
  SUGGEST_EDIT
  ADMIN
}

enum AnnotationType {
  HIGHLIGHT
  NOTE
  COMMENT
  QUESTION
  WARNING
}

enum SuggestEditPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum SuggestEditStatus {
  PENDING
  REVIEWED
  APPROVED
  REJECTED
  MIGRATED
}

enum RevisionType {
  NEW
  UPDATED
  MODIFIED
  DELETED
}

enum AccessMethod {
  CDN
  EMAIL
  FTP
  OFFLINE_DOWNLOAD
}

enum ReaderEventType {
  OPEN
  SEARCH
  ANNOTATE
  SUGGEST_EDIT
  BOOKMARK
  DOWNLOAD
}

// Epic-04: Compliance Monitoring Models

model RegulationLibrary {
  id               String @id @default(cuid())
  source           String // e.g., 'ICAO', 'EASA', 'FAA', 'EU-OPS'
  region           String // e.g., 'EU', 'US', 'GLOBAL', 'NORTH_ATLANTIC'
  title            String
  description      String?
  version          String
  effectiveDate    DateTime
  expiryDate       DateTime?
  url              String?
  metadata         Json?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  // Relations
  regulationItems RegulationItem[]
  complianceLinks ComplianceLink[]
  impactAnalyses ImpactAnalysis[]
  auditChecklists AuditChecklist[]
  libraryUpdateJobs LibraryUpdateJob[]
  
  @@map("regulation_libraries")
}

model RegulationItem {
  id                String @id @default(cuid())
  regulationLibraryId String
  regulationType    RegulationType
  reference         String // e.g., 'AMC1.OP.MLR.100', 'FAR 121.101'
  title             String
  content           String
  category          RegulationCategory
  priority          RegulationPriority
  applicability     Json // Aircraft types, operators, routes, conditions
  relatedRegulations String[] // References to other regulation IDs
  metadata          Json?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  // Relations
  regulationLibrary RegulationLibrary @relation(fields: [regulationLibraryId], references: [id], onDelete: Cascade)
  complianceLinks ComplianceLink[]
  auditChecklistItems AuditChecklistItem[]
  complianceAlerts ComplianceAlert[]
  
  @@map("regulation_items")
  @@unique([regulationLibraryId, reference])
}

model ComplianceLink {
  id               String @id @default(cuid())
  manualId         String
  chapterId       String
  sectionId        String
  blockId          String? // Optional paragraph-level linking
  regulationItemId String
  regulationLibraryId String
  linkType         ComplianceLinkType
  relationship     ComplianceRelationship
  confidence       Int // AI confidence score (0-100)
  createdBy        String
  reviewedBy       String?
  reviewedAt       DateTime?
  status           ComplianceLinkStatus @default(DRAFT)
  notes            String?
  evidence         String[] // Supporting documentation URLs
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  // Relations
  manual Manual @relation(fields: [manualId], references: [id], onDelete: Cascade)
  regulationItem RegulationItem @relation(fields: [regulationItemId], references: [id], onDelete: Cascade)
  regulationLibrary RegulationLibrary @relation(fields: [regulationLibraryId], references: [id], onDelete: Cascade)
  auditChecklistItem AuditChecklistItem?
  complianceAlerts ComplianceAlert[]
  
  @@map("compliance_links")
}

model ComplianceAlert {
  id                     String @id @default(cuid())
  organizationId         String
  alertType              ComplianceAlertType
  severity               ComplianceSeverity
  title                  String
  description            String
  affectedManualIds      String[]
  affectedComplianceLinks String[]
  regulationItemId       String?
  dueDate                DateTime?
  status                 ComplianceAlertStatus @default(ACTIVE)
  assignedTo             String?
  acknowledgedBy         String?
  acknowledgedAt         DateTime?
  resolvedBy             String?
  resolvedAt             DateTime?
  resolutionNotes        String?
  metadata               Json?
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt
  
  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  regulationItem RegulationItem @relation(fields: [regulationItemId], references: [id], onDelete: Cascade)
  complianceLinks ComplianceLink[]
  
  @@map("compliance_alerts")
}

model AuditChecklist {
  id                  String @id @default(cuid())
  organizationId      String
  manualId            String?
  title               String
  description         String?
  auditType           AuditType
  auditScope          AuditScope
  regulationLibraryIds String[]
  coverageRegions     String[]
  scheduledDate       DateTime
  completionDate      DateTime?
  auditorId           String?
  auditorName         String?
  auditStatus         AuditStatus @default(SCHEDULED)
  statistics          Json // Total, completed, failed items etc.
  metadata            Json?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  items AuditChecklistItem[]
  regulationLibs RegulationLibrary[]
  
  @@map("audit_checklists")
}

model AuditChecklistItem {
  id                 String @id @default(cuid())
  checklistId        String
  regulationItemId   String
  complianceLinkId   String?
  question           String
  description        String?
  applicableManualIds String[]
  evidenceRequired    String[]
  checkType          CheckType
  priority           AuditPriority
  status             AuditItemStatus @default(NOT_STARTED)
  checkedBy          String?
  checkedAt          DateTime?
  findings           String?
  recommendations    String?
  attachments        String[]
  metadata           Json?
  
  // Relations
  checklist AuditChecklist @relation(fields: [checklistId], references: [id], onDelete: Cascade)
  regulationItem RegulationItem @relation(fields: [regulationItemId], references: [id], onDelete: Cascade)
  complianceLink ComplianceLink @relation(fields: [complianceLinkId], references: [id])
  
  @@map("audit_checklist_items")
}

model ImpactAnalysis {
  id                  String @id @default(cuid())
  triggerType         ImpactTriggerType
  regulationLibraryId String
  oldVersion          String?
  newVersion          String
  analysisScope       Json // Organization IDs, manual IDs, regulation item IDs
  results             Json // Affected paragraphs, new/modified requirements, risk assessment
  recommendations      Json // Priority actions, responsible parties, deadlines
  automatedChecklistId String?
  status              ImpactAnalysisStatus @default(PENDING)
  analyzedBy          String?
  reviewedBy          String?
  reviewedAt          DateTime?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  // Relations
  regulationLibrary RegulationLibrary @relation(fields: [regulationLibraryId], references: [id], onDelete: Cascade)
  
  @@map("impact_analyses")
}

model CoverageAnalysis {
  id               String @id @default(cuid())
  organizationId   String
  manualId         String
  analysisDate     DateTime @default(now())
  scope            Json // Total vs linked paragraphs
  byChapter        Json // Coverage by chapter
  byRegulation     Json // Coverage by regulation library
  recommendations  Json // Suggested regulations for unlinked paragraphs
  metadata         Json?
  
  @@map("coverage_analyses")
}

model LibraryUpdateJob {
  id                    String @id @default(cuid())
  organizationId        String
  regulationLibraryId   String
  updateType            UpdateType
  oldVersion            String?
  newVersion           String
  description          String
  changes              Json // Added, modified, deleted, renumbered
  effectiveDate        DateTime
  implementationDeadline DateTime?
  notificationDate     DateTime
  status               JobStatus @default(PENDING)
  processingStartedAt  DateTime?
  processingCompletedAt DateTime?
  errorMessage         String?
  impactAnalysisId     String?
  generatedAlertIds    String[]
  generatedChecklistIds String[]
  metadata             Json?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  
  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  regulationLibrary RegulationLibrary @relation(fields: [regulationLibraryId], references: [id], onDelete: Cascade)
  
  @@map("library_update_jobs")
}

model ComplianceAnalytics {
  id             String @id @default(cuid())
  organizationId String
  userId         String
  action         ComplianceAction
  targetId       String // ComplianceLink, ComplianceAlert, or AuditChecklist ID
  metadata       Json?
  timestamp      DateTime @default(now())
  
  @@map("compliance_analytics")
}

// Epic-04 Enums

enum RegulationType {
  ARTICLE
  PARAGRAPH
  SECTION
  ANNEX
  APPENDIX
  AMC
  GM
  OTHER
}

enum RegulationCategory {
  OPERATIONAL
  SAFETY
  MAINTENANCE
  TRAINING
  EQUIPMENT
  DOCUMENTATION
  OTHER
}

enum RegulationPriority {
  CRITICAL
  HIGH
  MEDIUM
  LOW
}

enum ComplianceLinkType {
  DIRECT
  INDIRECT
  REQUIREMENT
  REFERENCE
  IMPLEMENTATION
}

enum ComplianceRelationship {
  IMPLEMENTS
  REFERENCES
  COMPLIES_WITH
  CONTRAVENES
  RELATED_TO
}

enum ComplianceLinkStatus {
  DRAFT
  ACTIVE
  QUESTIONED
  INVALID
}

enum ComplianceAlertType {
  REGULATION_UPDATE
  COMPLIANCE_GAP
  EXPIRING_REGULATION
  NEW_REQUIREMENT
  RISK_ASSESSMENT
}

enum ComplianceSeverity {
  CRITICAL
  HIGH
  MEDIUM
  LOW
  INFO
}

enum ComplianceAlertStatus {
  ACTIVE
  ACKNOWLEDGED
  MITIGATED
  RESOLVED
  DISMISSED
}

enum AuditType {
  REGULATORY
  COMPLIANCE
  SAFETY
  OPERATIONAL
  MAINTENANCE
  TRAINING
}

enum AuditScope {
  MANUAL
  OPERATIONS
  SAFETY
  MAINTENANCE
  TRAINING
  COMPREHENSIVE
}

enum AuditStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum CheckType {
  INSPECTION
  VERIFICATION
  DOCUMENTATION
  PROCEDURAL
  TRAINING
}

enum AuditPriority {
  CRITICAL
  HIGH
  MEDIUM
  LOW
}

enum AuditItemStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
  FAILED
  N_A
}

enum ImpactTriggerType {
  REGULATION_UPDATE
  MANUAL_CHANGE
  SCHEDULED_ASSESSMENT
  NON_CONFORMITY
}

enum ImpactAnalysisStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  REQUIRES_REVIEW
}

enum UpdateType {
  MAJOR
  MINOR
  PATCH
  NEW_REGULATION
}

enum JobStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

enum ComplianceAction {
  LINK_CREATED
  LINK_UPDATED
  LINK_DELETED
  ALERT_VIEWED
  CHECKLIST_ACCESSED
  IMPACT_ANALYZED
}

// Epic-05: AI-driven Semantic Search Models

model SearchIndex {
  id              String   @id @default(cuid())
  contentHash     String   @unique
  manualId        String
  chapterId       String
  sectionId       String
  paragraphId     String?
  version         String
  contentType     ContentType
  title           String
  content         Text
  semanticVector  Unsupported("vector(768)")? // OpenAI embedding vector
  bm25Tokens      String[] @default([])
  wordCount       Int
  anchorIds       String[] @default([])
  organizationId  String
  isReleased      Boolean
  indexedAt       DateTime @default(now())

  // Relations
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  manual          Manual       @relation(fields: [manualId], references: [id], onDelete: Cascade)
  chapter         Chapter      @relation(fields: [chapterId], references: [id], onDelete: Cascade)
  section         Section      @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  paragraph       Block?       @relation(fields: [paragraphId], references: [id], onDelete: Cascade)

  @@map("search_index")
  @@index([manualId, isReleased])
  @@index([organizationId, isReleased])
  @@index([version])
  @@index([contentType])
}

model IndexingJob {
  id            String         @id @default(cuid())
  type          IndexingType
  status        JobStatus
  progress      Json // { totalItems, processedItems, failedItems, currentPhase }
  triggeredBy   String
  startedAt     DateTime?
  completedAt   DateTime?
  errorMessage  String?
  metadata      Json?

  @@map("indexing_jobs")
}

model SearchAnalytics {
  id             String           @id @default(cuid())
  query          String
  userId         String?
  sessionId      String?
  responseTimeMs Int
  resultCount    Int
  resultScores   Float[]
  clickCount     Int              @default(0)
  outcome        SearchOutcome     @default(NO_CLICK)
  userAgent      String?
  timestamp      DateTime         @default(now())

  @@map("search_analytics")
  @@index([query])
  @@index([timestamp])
  @@index([userId])
}

// Enums for Epic-05

enum ContentType {
  PARAGRAPH
  SECTION
  CHAPTER
}

enum IndexingType {
  FULL_RECREATE
  INCREMENTAL
  MANUAL_TRIGGER
}

enum SearchOutcome {
  SATISFIED
  DISSAISFIED
  NO_CLICK
}
